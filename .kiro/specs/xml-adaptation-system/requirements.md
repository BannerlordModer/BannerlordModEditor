# 需求文档

## 介绍

XML 适配系统是 BannerlordModEditor C# 项目的一个综合性功能，它系统性地将 example/ModuleData/ 目录下的 XML 文件转换为强类型的 C# 模型，并提供完整的序列化/反序列化验证。该系统确保数据完整性和一致性，同时为处理复杂 XML 架构提供结构化的工作流程。

## 需求

### 需求 1

**用户故事：** 作为开发者，我希望能够自动识别未适配的 XML 文件，以便系统性地处理所有剩余文件而不遗漏任何一个。

#### 验收标准

1. 当执行 find_unadapted.py 脚本时，系统应扫描 example/ModuleData/ 目录并与 BannerlordModEditor.Common/Models/ 目录进行比较
2. 当比较目录时，系统应输出没有对应 C# 模型的 XML 文件列表
3. 当脚本完成时，系统应提供按复杂度或字母顺序排列的清晰列表

### 需求 2

**用户故事：** 作为开发者，我希望从 XML 文件创建强类型的 C# 模型，以便使用类型安全的对象而不是原始 XML。

#### 验收标准

1. 当分析 XML 文件时，系统应在适当的 BannerlordModEditor.Common/Models/ 子目录中创建对应的 C# 模型类
2. 当命名模型类时，系统应遵循 some_file_name.xml 变成 SomeFileName 类的约定
3. 当创建模型时，系统应仅使用标准的 System.Xml.Serialization 特性（[XmlRoot]、[XmlElement]、[XmlAttribute]）
4. 当遇到命名冲突时，系统应使用更具体的命名（例如，ActionType 而不是 Action）
5. 当定义可选属性时，系统应实现 public bool ShouldSerialize...() 方法以防止空值序列化

### 需求 3

**用户故事：** 作为开发者，我希望为每个 XML 适配提供全面的单元测试，以便确保序列化和反序列化过程中的数据完整性。

#### 验收标准

1. 当创建模型时，系统应在 BannerlordModEditor.Common.Tests/ 中创建名为 SomeFileNameXmlTests.cs 的对应测试文件
2. 当测试序列化时，系统应验证完整的往返过程：原始 XML → 反序列化 → C# 对象 → 序列化 → 新 XML
3. 当比较 XML 文档时，系统应使用 XNode.DeepEquals() 进行逻辑等价性验证
4. 当为比较而序列化时，系统应移除默认的 xmlns 命名空间以确保准确比较
5. 当所有测试通过时，系统应保证在转换过程中没有数据丢失或损坏

### 需求 4

**用户故事：** 作为开发者，我希望高效处理大型 XML 文件，以便测试不会消耗过多内存或时间。

#### 验收标准

1. 当遇到大于 1MB 或超过 10,000 行的 XML 文件时，系统应将其分割成较小的块
2. 当分割文件时，系统应使用 split_large_xml.py 脚本和可配置的块大小
3. 当创建分割文件时，系统应将其存储在 BannerlordModEditor.Common.Tests/TestSubsets/ 的适当子目录中
4. 当测试分割文件时，系统应使用 [Theory] 和 [MemberData] 特性独立测试每个块
5. 当处理块时，系统应为每个子集维护相同的往返验证

### 需求 5

**用户故事：** 作为开发者，我希望为每个适配提供结构化的版本控制，以便跟踪进度并维护清洁的提交历史。

#### 验收标准

1. 当完成 XML 文件适配时，系统应创建包含所有相关文件的单个 Git 提交
2. 当提交时，系统应包括 C# 模型、测试文件、测试数据文件和任何辅助脚本
3. 当编写提交消息时，系统应遵循约定式提交格式："feat: Adapt some_file_name.xml"
4. 当提交时，系统应仅执行 git add 和 git commit 操作，不执行 git push
5. 当审查提交时，每个提交应代表一个 XML 文件的完整、可工作的适配

### 需求 6

**用户故事：** 作为开发者，我希望在既定的项目约束内工作，以便适配能够无缝集成到现有代码库中。

#### 验收标准

1. 当构建项目时，系统应针对 .NET 9 框架
2. 当运行测试时，系统应使用 xUnit 测试框架
3. 当遇到可空引用警告时，系统应确认这些警告可以被忽略而不影响功能
4. 当与现有代码集成时，系统应保持与当前项目结构和约定的兼容性
5. 当完成适配时，系统应确保所有模型在更广泛的 BannerlordModEditor 生态系统中正确工作