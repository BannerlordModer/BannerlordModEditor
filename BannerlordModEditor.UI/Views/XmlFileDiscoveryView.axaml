<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BannerlordModEditor.UI.ViewModels"
             x:Class="BannerlordModEditor.UI.Views.XmlFileDiscoveryView"
             x:DataType="vm:XmlFileDiscoveryViewModel">

  <Grid RowDefinitions="Auto,*,Auto">
    <!-- å·¥å…·æ  -->
    <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,0,0,1" Padding="16,12">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto,Auto">
        <Button Grid.Column="0" Content="ðŸ” æ‰«ææ–‡ä»¶" Command="{Binding ScanFilesAsyncCommand}" Margin="0,0,8,0" Classes="accent" />
        <Button Grid.Column="1" Content="ðŸ”„ åˆ·æ–°" Command="{Binding RefreshAsyncCommand}" Margin="0,0,16,0" Classes="accent" />
        
        <!-- æœç´¢æ¡† -->
        <TextBox Grid.Column="3" Text="{Binding SearchFilter}" 
                 Watermark="æœç´¢XMLæ–‡ä»¶..." 
                 Margin="8,0"
                 Width="200"
                 VerticalAlignment="Center" />
        
        <!-- è®¡æ•°ä¿¡æ¯ -->
        <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
          <TextBlock Text="æ€»è®¡: " Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
          <TextBlock Text="{Binding TotalFilesCount}" FontWeight="Medium" />
          <TextBlock Text=" | å·²é€‚é…: " Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="8,0,0,0" />
          <TextBlock Text="{Binding AdaptedFilesCount}" FontWeight="Medium" />
          <TextBlock Text=" | æœªé€‚é…: " Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="8,0,0,0" />
          <TextBlock Text="{Binding UnadaptedFilesCount}" FontWeight="Medium" />
        </StackPanel>
        
        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <ProgressBar Grid.Column="5" 
                     IsIndeterminate="True" 
                     Width="100" 
                     Height="20"
                     IsVisible="{Binding IsScanning}" />
      </Grid>
    </Border>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <TabControl Grid.Row="1" Classes="file-tabs">
      <!-- æ‰€æœ‰æ–‡ä»¶æ ‡ç­¾é¡µ -->
      <TabItem Header="æ‰€æœ‰æ–‡ä»¶" Classes="all-files">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>
          
          <!-- æ–‡ä»¶åˆ—è¡¨ -->
          <DataGrid Grid.Row="0"
                    ItemsSource="{Binding AvailableFiles}"
                    AutoGenerateColumns="False"
                    CanUserResizeColumns="True"
                    CanUserSortColumns="True"
                    GridLinesVisibility="Horizontal"
                    HeadersVisibility="Column"
                    Margin="8">
            
            <DataGrid.Columns>
              <DataGridTextColumn Header="æ–‡ä»¶å" Binding="{Binding FileName}" Width="200" />
              <DataGridTextColumn Header="ç›¸å¯¹è·¯å¾„" Binding="{Binding RelativePath}" Width="300" />
              <DataGridTextColumn Header="å¤§å°" Binding="{Binding FileSize, StringFormat='{}{0} bytes'}" Width="100" />
              <DataGridTextColumn Header="ä¿®æ”¹æ—¶é—´" Binding="{Binding LastModified, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" Width="150" />
              <DataGridTextColumn Header="çŠ¶æ€" Binding="{Binding Status}" Width="80" />
              <DataGridTemplateColumn Header="æ“ä½œ" Width="150">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <Button Content="æ‰“å¼€" Classes="accent" FontSize="10" Padding="4,2"
                              Command="{Binding $parent[DataGrid].((vm:XmlFileDiscoveryViewModel)DataContext).OpenFileCommand}"
                              CommandParameter="{Binding}" />
                      <Button Content="é€‚é…" Classes="accent" FontSize="10" Padding="4,2"
                              Command="{Binding $parent[DataGrid].((vm:XmlFileDiscoveryViewModel)DataContext).AdaptFileAsyncCommand}"
                              CommandParameter="{Binding}"
                              IsVisible="{Binding !IsAdapted}" />
                    </StackPanel>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
            </DataGrid.Columns>
          </DataGrid>
          
          <!-- çŠ¶æ€ä¿¡æ¯ -->
          <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" 
                  Padding="8" Margin="0,4,0,0">
            <TextBlock Text="{Binding StatusMessage}" 
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       FontSize="12" />
          </Border>
        </Grid>
      </TabItem>
      
      <!-- å·²é€‚é…æ–‡ä»¶æ ‡ç­¾é¡µ -->
      <TabItem Header="å·²é€‚é…æ–‡ä»¶" Classes="adapted-files">
        <DataGrid ItemsSource="{Binding AdaptedFiles}"
                  AutoGenerateColumns="False"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  Margin="8">
          
          <DataGrid.Columns>
            <DataGridTextColumn Header="æ–‡ä»¶å" Binding="{Binding FileName}" Width="200" />
            <DataGridTextColumn Header="ç›¸å¯¹è·¯å¾„" Binding="{Binding RelativePath}" Width="300" />
            <DataGridTextColumn Header="å¤§å°" Binding="{Binding FileSize, StringFormat='{}{0} bytes'}" Width="100" />
            <DataGridTextColumn Header="ä¿®æ”¹æ—¶é—´" Binding="{Binding LastModified, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" Width="150" />
            <DataGridTemplateColumn Header="æ“ä½œ" Width="80">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <Button Content="æ‰“å¼€" Classes="accent" FontSize="10" Padding="4,2"
                          Command="{Binding $parent[DataGrid].((vm:XmlFileDiscoveryViewModel)DataContext).OpenFileCommand}"
                          CommandParameter="{Binding}" />
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>
          </DataGrid.Columns>
        </DataGrid>
      </TabItem>
      
      <!-- æœªé€‚é…æ–‡ä»¶æ ‡ç­¾é¡µ -->
      <TabItem Header="æœªé€‚é…æ–‡ä»¶" Classes="unadapted-files">
        <DataGrid ItemsSource="{Binding UnadaptedFiles}"
                  AutoGenerateColumns="False"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  Margin="8">
          
          <DataGrid.Columns>
            <DataGridTextColumn Header="æ–‡ä»¶å" Binding="{Binding FileName}" Width="200" />
            <DataGridTextColumn Header="ç›¸å¯¹è·¯å¾„" Binding="{Binding RelativePath}" Width="300" />
            <DataGridTextColumn Header="å¤§å°" Binding="{Binding FileSize, StringFormat='{}{0} bytes'}" Width="100" />
            <DataGridTextColumn Header="ä¿®æ”¹æ—¶é—´" Binding="{Binding LastModified, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" Width="150" />
            <DataGridTemplateColumn Header="æ“ä½œ" Width="80">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <Button Content="é€‚é…" Classes="accent" FontSize="10" Padding="4,2"
                          Command="{Binding $parent[DataGrid].((vm:XmlFileDiscoveryViewModel)DataContext).AdaptFileAsyncCommand}"
                          CommandParameter="{Binding}" />
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>
          </DataGrid.Columns>
        </DataGrid>
      </TabItem>
    </TabControl>

    <!-- åº•éƒ¨å·¥å…·æ  -->
    <Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundAltHighBrush}" 
            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,1,0,0" 
            Padding="16,8">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
          <Button Content="ðŸ“ æ‰¹é‡é€‚é…" Classes="accent" />
          <Button Content="ðŸ“Š ç”ŸæˆæŠ¥å‘Š" Classes="accent" />
        </StackPanel>
        
        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <TextBlock Grid.Column="2" 
                   Text="æç¤º: ç‚¹å‡»'æ‰«ææ–‡ä»¶'å¼€å§‹æœç´¢XMLæ–‡ä»¶ï¼Œä½¿ç”¨æœç´¢æ¡†å¯å¿«é€Ÿè¿‡æ»¤æ–‡ä»¶"
                   Foreground="{DynamicResource SystemControlForegroundBaseLowBrush}"
                   FontSize="11"
                   VerticalAlignment="Center" />
      </Grid>
    </Border>
  </Grid>

  <!-- æ ·å¼å®šä¹‰ -->
  <UserControl.Styles>
    <Style Selector="TabControl.file-tabs">
      <Setter Property="Background" Value="Transparent" />
    </Style>
    
    <Style Selector="TabItem.all-files">
      <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundAltHighBrush}" />
    </Style>
    
    <Style Selector="TabItem.adapted-files">
      <Setter Property="Background" Value="{DynamicResource SystemControlSuccessBackgroundBrush}" />
    </Style>
    
    <Style Selector="TabItem.unadapted-files">
      <Setter Property="Background" Value="{DynamicResource SystemControlWarningBackgroundBrush}" />
    </Style>
  </UserControl.Styles>
</UserControl>