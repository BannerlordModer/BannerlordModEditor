# BannerIconsMapper 类型转换修复需求文档

## 项目概述

本项目旨在修复BannerlordModEditor中BannerIconsMapper的类型转换问题，确保DO和DTO模型之间的正确映射，并保证XML序列化的一致性。

## 执行摘要

BannerIconsMapper需要修复类型转换逻辑，确保在DO和DTO模型之间正确处理数值类型和布尔类型的转换。当前映射器直接进行字符串属性赋值，没有充分利用模型中定义的类型安全便捷属性。

## 利益相关者

### 主要用户
- **开发团队**：需要稳定的XML映射功能来处理骑马与砍杀2的配置文件
- **测试团队**：需要可靠的测试覆盖来验证XML序列化/反序列化功能
- **最终用户**：需要稳定的Mod编辑器来处理游戏配置

### 次要用户
- **系统管理员**：需要稳定的部署和运行环境
- **Mod开发者**：需要可靠的工具来创建和修改游戏Mod

## 功能需求

### FR-001: BannerIconGroupMapper 类型转换修复
**描述**：修复BannerIconGroupMapper中的类型转换逻辑，确保Id和IsPattern属性正确处理数值和布尔类型转换  
**优先级**：高  
**验收标准**：
- [ ] Id属性能够正确处理数值类型转换（字符串 ↔ int）
- [ ] IsPattern属性能够正确处理布尔类型转换（字符串 ↔ bool）
- [ ] 映射后的对象在XML序列化时保持结构一致性
- [ ] 所有相关的单元测试通过

### FR-002: BackgroundMapper 类型转换修复
**描述**：修复BackgroundMapper中的类型转换逻辑，确保Id和IsBaseBackground属性正确处理数值和布尔类型转换  
**优先级**：高  
**验收标准**：
- [ ] Id属性能够正确处理数值类型转换（字符串 ↔ int）
- [ ] IsBaseBackground属性能够正确处理布尔类型转换（字符串 ↔ bool）
- [ ] 映射后的对象在XML序列化时保持结构一致性
- [ ] 所有相关的单元测试通过

### FR-003: IconMapper 类型转换修复
**描述**：修复IconMapper中的类型转换逻辑，确保Id、TextureIndex和IsReserved属性正确处理数值和布尔类型转换  
**优先级**：高  
**验收标准**：
- [ ] Id属性能够正确处理数值类型转换（字符串 ↔ int）
- [ ] TextureIndex属性能够正确处理数值类型转换（字符串 ↔ int）
- [ ] IsReserved属性能够正确处理布尔类型转换（字符串 ↔ bool）
- [ ] 映射后的对象在XML序列化时保持结构一致性
- [ ] 所有相关的单元测试通过

### FR-004: ColorEntryMapper 类型转换修复
**描述**：修复ColorEntryMapper中的类型转换逻辑，确保Id、PlayerCanChooseForBackground和PlayerCanChooseForSigil属性正确处理数值和布尔类型转换  
**优先级**：高  
**验收标准**：
- [ ] Id属性能够正确处理数值类型转换（字符串 ↔ int）
- [ ] PlayerCanChooseForBackground属性能够正确处理布尔类型转换（字符串 ↔ bool）
- [ ] PlayerCanChooseForSigil属性能够正确处理布尔类型转换（字符串 ↔ bool）
- [ ] 映射后的对象在XML序列化时保持结构一致性
- [ ] 所有相关的单元测试通过

### FR-005: XML序列化一致性保证
**描述**：确保修复后的映射器能够保持XML序列化的一致性，反序列化后再序列化的结果与原始XML结构完全一致  
**优先级**：高  
**验收标准**：
- [ ] BannerIconsXmlTests中的BannerIcons_RoundTrip_StructuralEquality测试通过
- [ ] 序列化后的XML节点数量与原始XML一致
- [ ] 序列化后的XML属性数量与原始XML一致
- [ ] 序列化后的XML属性值与原始XML一致
- [ ] 序列化后的XML文本内容与原始XML一致

## 非功能性需求

### NFR-001: 性能
**描述**：修复后的映射器性能不能低于当前实现  
**度量标准**：
- 映射操作响应时间 < 10ms
- 内存使用增长率 < 5%
- 不影响现有功能的性能

### NFR-002: 可靠性
**描述**：修复后的映射器必须处理各种边界情况  
**度量标准**：
- 正确处理null值输入
- 正确处理空字符串输入
- 正确处理格式错误的数值和布尔值
- 不抛出未处理的异常

### NFR-003: 可维护性
**描述**：修复后的代码必须易于维护和扩展  
**度量标准**：
- 代码遵循项目编码规范
- 添加适当的注释说明类型转换逻辑
- 保持代码结构清晰，便于后续修改

### NFR-004: 向后兼容性
**描述**：修复后的代码必须保持向后兼容性  
**度量标准**：
- 不破坏现有的API接口
- 不影响其他使用映射器的功能
- 保持现有测试的通过率

## 约束条件

### 技术约束
- 必须使用.NET 9.0框架
- 必须遵循项目的DO/DTO架构模式
- 必须保持XML序列化兼容性
- 必须使用现有的XmlTestUtils工具

### 业务约束
- 不能破坏现有的XML处理功能
- 必须支持骑马与砍杀2的所有BannerIcons配置
- 必须保持与现有代码库的一致性

### 时间约束
- 必须在当前开发周期内完成
- 需要确保有足够的测试时间

## 假设条件

- DO模型和DTO模型的结构是正确的
- XML测试数据是完整和准确的
- 现有的XmlTestUtils工具功能正常
- 开发环境配置正确

## 超出范围

- 修改DO或DTO模型的基本结构
- 重构整个XML序列化系统
- 添加新的XML处理功能
- 修改其他不相关的映射器

## 依赖关系

- 依赖于BannerIconsDO模型的便捷属性
- 依赖于BannerIconsDTO模型的设置方法
- 依赖于XmlTestUtils的序列化/反序列化功能
- 依赖于测试数据的准确性

## 风险评估

### 高风险
- 类型转换错误可能导致XML序列化失败
- 修改可能影响现有的XML处理功能
- 测试覆盖不足可能导致回归问题

### 中风险
- 性能可能受到轻微影响
- 代码复杂度可能增加
- 维护成本可能增加

### 低风险
- 向后兼容性问题
- 文档更新需求

## 成功标准

### 技术成功标准
- 所有BannerIcons相关的XML序列化测试通过
- 类型转换逻辑正确处理所有边界情况
- 代码质量符合项目标准

### 业务成功标准
- 用户能够正常处理BannerIcons配置文件
- 不影响现有的Mod编辑功能
- 系统稳定性得到提升

## 验收流程

1. **单元测试**：运行所有相关的单元测试
2. **集成测试**：测试完整的XML序列化/反序列化流程
3. **回归测试**：确保不影响现有功能
4. **性能测试**：验证性能没有明显下降
5. **用户验收测试**：验证功能满足用户需求

## 附录

### 术语表
- **DO (Domain Object)**：领域对象，用于业务逻辑处理
- **DTO (Data Transfer Object)**：数据传输对象，用于序列化/反序列化
- **XML序列化**：将对象转换为XML格式的过程
- **XML反序列化**：将XML转换为对象的过程

### 参考资料
- 项目DO/DTO架构模式文档
- BannerIcons XML测试数据
- XmlTestUtils工具文档
- 骑马与砍杀2 Mod开发文档