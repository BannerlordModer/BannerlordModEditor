# Bannerlord Mod Editor TUI - 用户指南

## 概述

Bannerlord Mod Editor TUI 是一个基于终端用户界面（TUI）的工具，专门用于《骑马与砍杀2：霸主》（Mount & Blade II: Bannerlord）模组开发者的XML配置文件转换。该工具提供了Excel和XML格式之间的双向转换功能，支持批量处理和格式验证。

## 主要功能

- **Excel转XML**：将Excel文件转换为XML格式，适用于模组配置
- **XML转Excel**：将XML文件转换为Excel格式，便于编辑和分析
- **格式验证**：自动检测和验证文件格式
- **错误处理**：完善的错误处理和异常捕获机制
- **批量处理**：支持大文件和批量数据处理
- **备份功能**：自动创建文件备份
- **快捷键支持**：完整的键盘快捷键操作

## 系统要求

- .NET 9.0 或更高版本
- 支持的操作系统：Windows、Linux、macOS
- 终端支持：支持ANSI转义序列的终端

## 安装和运行

### 从源码编译

```bash
# 克隆项目
git clone <repository-url>
cd BannerlordModEditor-TUI-Development

# 还原依赖
dotnet restore

# 编译项目
dotnet build

# 运行TUI应用程序
dotnet run --project BannerlordModEditor.TUI
```

### 运行测试

```bash
# 运行所有测试
dotnet test

# 运行特定项目的测试
dotnet test BannerlordModEditor.TUI.Tests
```

## 使用指南

### 启动应用程序

运行应用程序后，您将看到一个基于终端的用户界面，包含以下主要组件：

1. **标题栏**：显示应用程序名称和版本信息
2. **源文件路径**：显示和选择要转换的源文件
3. **目标文件路径**：显示和选择转换后的目标文件
4. **转换方向**：Excel转XML 或 XML转Excel
5. **操作按钮**：浏览、分析、转换、选项、清空等操作
6. **状态栏**：显示当前操作状态和进度信息

### 基本操作流程

#### 1. 选择源文件

- 按 **F2** 或点击「浏览源文件」按钮
- 在文件选择对话框中选择要转换的文件
- 支持的文件格式：
  - Excel文件：`.xlsx`, `.xls`
  - XML文件：`.xml`

#### 2. 分析文件

- 按 **F3** 或点击「分析文件」按钮
- 系统会自动分析文件格式和结构
- 分析结果会显示在状态栏中

#### 3. 选择目标文件

- 按 **F4** 或点击「浏览目标文件」按钮
- 选择转换后的文件保存位置
- 系统会根据转换方向自动建议文件扩展名

#### 4. 执行转换

- 按 **F5** 或点击「执行转换」按钮
- 系统会开始转换过程
- 进度条会显示转换进度
- 转换完成后会显示结果对话框

### 快捷键参考

| 快捷键 | 功能描述 |
|--------|----------|
| **F1** | 切换转换方向（Excel↔XML） |
| **F2** | 浏览源文件 |
| **F3** | 分析文件 |
| **F4** | 浏览目标文件 |
| **F5** | 执行转换 |
| **F6** | 打开转换选项 |
| **F7** | 清空表单 |
| **F8/Esc** | 退出程序 |

### 转换选项

按 **F6** 打开转换选项对话框，可以配置以下选项：

- **包含架构验证**：在转换后验证XML架构
- **保留格式**：在转换过程中保留格式信息
- **创建备份**：在覆盖目标文件前创建备份
- **工作表名称**：指定Excel工作表名称
- **根元素名称**：指定XML根元素名称
- **行元素名称**：指定XML行元素名称
- **扁平化嵌套元素**：将嵌套XML元素扁平化
- **嵌套元素分隔符**：嵌套元素的分隔符

### 文件格式要求

#### Excel文件格式

- 第一行必须包含列标题
- 数据从第二行开始
- 支持多列数据
- 列标题将作为XML元素名称

#### XML文件格式

- 必须是有效的XML文档
- 支持嵌套元素结构
- 根元素下的子元素将作为数据行
- 元素名称将作为Excel列标题

### 错误处理

应用程序提供了完善的错误处理机制：

- **文件不存在**：提示文件路径错误
- **格式不支持**：提示支持的文件格式
- **权限不足**：提示文件访问权限问题
- **数据格式错误**：提示具体的格式问题
- **内存不足**：处理大文件时的内存管理

### 性能优化

- 支持大文件处理（测试支持1000+行数据）
- 异步操作避免界面冻结
- 内存管理优化
- 进度显示和状态反馈

## 故障排除

### 常见问题

#### 1. 应用程序无法启动

**解决方案**：
- 确认安装了.NET 9.0
- 检查终端是否支持ANSI转义序列
- 尝试在不同的终端中运行

#### 2. 文件转换失败

**解决方案**：
- 检查文件是否被其他程序占用
- 确认文件格式正确
- 检查文件访问权限
- 查看错误信息了解具体原因

#### 3. 内存不足错误

**解决方案**：
- 减少处理的数据量
- 关闭其他占用内存的程序
- 分批处理大文件

#### 4. 终端显示问题

**解决方案**：
- 调整终端窗口大小
- 确认终端编码设置为UTF-8
- 尝试不同的终端模拟器

### 日志和调试

应用程序会在控制台输出详细的错误信息，包括：

- 错误类型和原因
- 文件路径和名称
- 建议的解决方案
- 操作堆栈跟踪

## 开发信息

### 项目结构

```
BannerlordModEditor-TUI-Development/
├── BannerlordModEditor.Common/           # 核心业务逻辑
├── BannerlordModEditor.TUI/               # TUI应用程序
├── BannerlordModEditor.TUI.Tests/         # TUI单元测试
├── BannerlordModEditor.Common.Tests/     # Common层测试
└── docs/                                 # 用户文档
```

### 技术栈

- **.NET 9.0**：最新的.NET平台
- **Terminal.Gui**：跨平台TUI框架
- **xUnit**：单元测试框架
- **ClosedXML**：Excel文件处理
- **System.Xml**：XML文件处理

### 扩展开发

该项目采用模块化设计，可以轻松扩展：

1. **添加新的文件格式支持**：在FormatConversionService中添加新的转换逻辑
2. **自定义验证规则**：扩展ValidationResult类
3. **新的UI组件**：基于Terminal.Gui添加新的界面元素
4. **批处理功能**：添加批量文件处理能力

## 版本历史

### v1.0.0 (当前版本)

- 初始版本发布
- 支持Excel和XML双向转换
- 完整的TUI用户界面
- 键盘快捷键支持
- 错误处理和异常捕获
- 单元测试覆盖

## 贡献指南

欢迎贡献代码和建议！请遵循以下步骤：

1. Fork项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

## 许可证

本项目采用MIT许可证。详情请参阅LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 项目Issues：[GitHub Issues]
- 邮箱：[开发团队邮箱]

---

**注意**：本工具专为《骑马与砍杀2：霸主》模组开发者设计，请确保在使用前备份重要的配置文件。