# ParticleSystems XML序列化修复需求文档

## 项目概述

BannerlordModEditor是一个骑马与砍杀2的Mod编辑器工具，采用C#和.NET 9开发。项目使用DO/DTO架构模式处理XML配置文件的序列化和反序列化。

## 问题分析

### 当前问题
1. **测试失败**: `ParticleSystemsHardcodedMisc1XmlTests`测试失败，`AreStructurallyEqual`返回false
2. **数据丢失**: 序列化过程中丢失了84个元素和212个属性
3. **结构不匹配**: 原始XML和序列化后XML结构存在差异

### 根本原因分析
通过详细分析发现，问题主要集中在以下几个方面：

#### 1. DecalMaterials序列化逻辑错误
- **问题**: `DecalMaterialsDO`的`ShouldSerializeDecalMaterialList`方法过于严格
- **影响**: 导致空的`decal_materials`元素被省略
- **证据**: 原始XML中有18个`decal_materials`元素，其中部分为空

#### 2. 曲线元素丢失
- **问题**: 丢失了20个`curve`元素、44个`key`元素和20个`keys`元素
- **影响**: 粒子系统的动画曲线配置不完整
- **证据**: 详细分析报告显示曲线相关元素数量不匹配

#### 3. 复杂嵌套结构处理不当
- **问题**: 多层嵌套的XML结构在序列化时出现逻辑错误
- **影响**: 粒子发射器、参数、标志等配置丢失

## 功能需求

### FR-001: 修复DecalMaterials序列化逻辑
**描述**: 修复DecalMaterialsDO的序列化逻辑，确保空的decal_materials元素能够正确保留
**优先级**: 高
**验收标准**:
- [ ] 空的decal_materials元素在序列化后仍然存在
- [ ] 包含decal_material子元素的decal_materials正确序列化
- [ ] 不影响其他相关元素的序列化

### FR-002: 修复曲线元素序列化问题
**描述**: 修复curve、key、keys等曲线相关元素的序列化逻辑
**优先级**: 高
**验收标准**:
- [ ] 所有curve元素正确序列化（预期684个）
- [ ] 所有key元素正确序列化（预期2761个）
- [ ] 所有keys元素正确序列化（预期1124个）
- [ ] 曲线参数的嵌套结构保持完整

### FR-003: 优化复杂嵌套结构处理
**描述**: 优化ParticleSystemsDO中复杂嵌套结构的处理逻辑
**优先级**: 中
**验收标准**:
- [ ] effect -> emitters -> emitter -> children/flags/parameters的嵌套结构正确处理
- [ ] 多层级的children嵌套正确处理
- [ ] 参数中的curve、color、alpha等复杂元素正确处理

### FR-004: 添加特殊处理逻辑
**描述**: 在XmlTestUtils中添加ParticleSystemsDO的特殊处理逻辑
**优先级**: 中
**验收标准**:
- [ ] 检测空的decal_materials元素
- [ ] 检测曲线相关元素的完整性
- [ ] 设置相应的标记属性以控制序列化行为

## 技术需求

### TR-001: 模型结构优化
**描述**: 优化ParticleSystemsDO的模型结构，确保能够准确反映XML的复杂结构
**要求**:
- 添加标记属性来跟踪空元素状态
- 优化ShouldSerialize方法的逻辑
- 确保所有可能的XML结构都能被正确处理

### TR-002: 序列化控制增强
**描述**: 增强对XML序列化的精细控制
**要求**:
- 区分元素不存在和元素为空的情况
- 保持XML元素的原始顺序
- 正确处理命名空间和属性

### TR-003: 性能优化
**描述**: 优化大型XML文件的处理性能
**要求**:
- 支持异步处理大型XML文件
- 减少内存使用
- 提高序列化/反序列化速度

### TR-004: 测试覆盖增强
**描述**: 增强测试覆盖，确保修复的稳定性
**要求**:
- 添加单元测试覆盖所有修复的场景
- 添加集成测试验证完整的序列化流程
- 添加性能测试确保不影响处理速度

## 非功能性需求

### NFR-001: 准确性
**描述**: 确保XML序列化的100%准确性
**指标**:
- 序列化前后XML结构完全一致
- 不丢失任何元素或属性
- 保持原始格式和缩进

### NFR-002: 性能
**描述**: 确保大型XML文件的处理性能
**指标**:
- 1.7MB XML文件处理时间 < 5秒
- 内存使用峰值 < 100MB
- 支持并行处理多个XML文件

### NFR-003: 可维护性
**描述**: 确保代码的可维护性和可扩展性
**指标**:
- 代码覆盖率 > 90%
- 遵循项目编码规范
- 提供完整的文档和注释

### NFR-004: 向后兼容性
**描述**: 确保修复不会破坏现有功能
**指标**:
- 所有现有测试继续通过
- 不影响其他XML类型的处理
- 保持API接口不变

## 约束条件

### 技术约束
- 必须使用C#和.NET 9
- 必须遵循项目的DO/DTO架构模式
- 必须使用现有的XmlTestUtils框架

### 业务约束
- 不能修改原始XML文件的结构
- 必须保持与骑马与砍杀2游戏配置的兼容性
- 必须支持所有现有的粒子系统配置

### 时间约束
- 修复必须在下一个版本发布前完成
- 测试必须在所有支持的平台上通过
- 文档必须同步更新

## 假设

### 技术假设
- XML文件格式符合骑马与砍杀2的标准
- 系统有足够的内存处理大型XML文件
- .NET 9的XML序列化框架能够处理复杂结构

### 业务假设
- 用户需要编辑所有类型的粒子系统配置
- 配置文件的结构相对稳定
- 性能要求满足大多数使用场景

## 风险评估

| 风险 | 影响程度 | 发生概率 | 缓解措施 |
|------|----------|----------|----------|
| 复杂嵌套结构处理不当 | 高 | 中 | 分步骤实现，充分测试 |
| 性能问题 | 中 | 中 | 进行性能测试，优化算法 |
| 向后兼容性破坏 | 高 | 低 | 保持现有接口，添加新功能 |
| 测试覆盖不足 | 中 | 中 | 增加测试用例，提高覆盖率 |

## 成功标准

### 技术成功标准
- ParticleSystemsHardcodedMisc1XmlTests测试通过
- 所有相关的XML序列化测试通过
- 性能指标满足要求

### 业务成功标准
- 用户能够成功编辑和保存粒子系统配置
- 配置文件在游戏中正常工作
- 编辑器性能满足用户期望

## 附录

### A. 问题分析数据
- 原始XML元素数量: 22,818
- 序列化后XML元素数量: 22,734
- 元素差异: 84
- 原始XML属性数量: 46,787
- 序列化后XML属性数量: 46,575
- 属性差异: 212

### B. 丢失元素统计
- curve元素: 20个丢失
- key元素: 44个丢失
- keys元素: 20个丢失
- decal_materials元素: 部分空的元素丢失

### C. 相关文件
- `/BannerlordModEditor.Common/Models/DO/ParticleSystemsDO.cs`
- `/BannerlordModEditor.Common.Tests/ParticleSystemsHardcodedMisc1XmlTests.cs`
- `/BannerlordModEditor.Common.Tests/XmlTestUtils.cs`
- `/BannerlordModEditor.Common.Tests/TestData/particle_systems_hardcoded_misc1.xml`