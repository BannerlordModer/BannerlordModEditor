# ParticleSystems XML序列化修复用户故事

## 项目背景

BannerlordModEditor是一个骑马与砍杀2的Mod编辑器工具，当前面临ParticleSystems XML序列化测试失败的问题。用户需要能够编辑和保存复杂的粒子系统配置，而不会丢失任何数据。

## 目标用户

### 主要用户
- **Mod开发者**: 需要编辑粒子系统配置的专业用户
- **技术用户**: 熟悉XML结构和游戏配置的高级用户

### 次要用户
- **测试人员**: 负责验证XML序列化功能的质量保证人员
- **系统维护者**: 负责维护和更新编辑器的开发人员

## 用户故事

### Epic: XML序列化完整性修复

#### Story: PRT-001 - 修复DecalMaterials序列化问题
**作为** 一个Mod开发者  
**我想要** 编辑包含空decal_materials元素的粒子系统配置  
**以便** 我的配置在保存后不会丢失任何元素  

**验收标准** (EARS格式):
- **WHEN** 我编辑一个包含空decal_materials元素的粒子系统配置 **THEN** 保存后的配置应该保留所有空的decal_materials元素
- **IF** 原始XML中存在空的decal_materials元素 **THEN** 序列化后的XML应该包含相同数量的空元素
- **FOR** 所有包含decal_materials的粒子系统配置 **VERIFY** 序列化前后元素数量完全一致

**技术说明**:
- 需要在ParticleSystemsDO中添加HasEmptyDecalMaterials标记属性
- 修改DecalMaterialsDO的ShouldSerializeDecalMaterialList方法
- 在XmlTestUtils中添加特殊处理逻辑检测空元素

**故事点**: 5
**优先级**: 高

---

#### Story: PRT-002 - 修复曲线元素序列化问题
**作为** 一个Mod开发者  
**我想要** 编辑包含复杂动画曲线的粒子系统  
**以便** 我的曲线配置在保存后保持完整  

**验收标准** (EARS格式):
- **WHEN** 我编辑包含curve、key、keys元素的粒子系统配置 **THEN** 保存后的配置应该包含所有曲线相关元素
- **IF** 原始XML中有684个curve元素 **THEN** 序列化后的XML应该包含完全相同的684个curve元素
- **FOR** 所有包含动画曲线的粒子系统参数 **VERIFY** 曲线嵌套结构保持完整

**技术说明**:
- 需要分析曲线元素丢失的具体原因
- 可能需要在ParameterDO中添加特殊处理逻辑
- 确保curve、keys、key元素的嵌套关系正确处理

**故事点**: 8
**优先级**: 高

---

#### Story: PRT-003 - 优化复杂嵌套结构处理
**作为** 一个系统维护者  
**我想要** 粒子系统的复杂嵌套结构能够正确序列化  
**以便** 用户可以编辑任何类型的粒子系统配置  

**验收标准** (EARS格式):
- **WHEN** 我编辑包含多层嵌套结构的粒子系统配置 **THEN** 保存后的配置应该保持完整的嵌套结构
- **IF** 配置包含effect -> emitters -> emitter -> children/flags/parameters的嵌套关系 **THEN** 序列化后应该保持相同的嵌套层次
- **FOR** 所有复杂的粒子系统配置 **VERIFY** 嵌套结构的完整性和正确性

**技术说明**:
- 需要优化ParticleSystemsDO的嵌套结构处理
- 添加适当的标记属性来跟踪空元素状态
- 确保多层级的children嵌套正确处理

**故事点**: 13
**优先级**: 中

---

#### Story: PRT-004 - 添加特殊处理逻辑
**作为** 一个测试人员  
**我想要** XmlTestUtils能够正确处理ParticleSystemsDO的特殊情况  
**以便** 我可以验证序列化的正确性  

**验收标准** (EARS格式):
- **WHEN** 我使用XmlTestUtils测试ParticleSystemsDO序列化 **THEN** 应该能够正确检测和处理所有特殊情况
- **IF** 反序列化ParticleSystemsDO对象 **THEN** XmlTestUtils应该自动设置必要的标记属性
- **FOR** 所有ParticleSystems相关的测试 **VERIFY** 测试结果的准确性和一致性

**技术说明**:
- 需要在XmlTestUtils.Deserialize方法中添加ParticleSystemsDO的特殊处理
- 实现检测空decal_materials元素的逻辑
- 添加曲线元素完整性的验证逻辑

**故事点**: 5
**优先级**: 中

---

#### Story: PRT-005 - 性能优化
**作为** 一个Mod开发者  
**我想要** 大型粒子系统配置文件能够快速加载和保存  
**以便** 我的工作流程不会被性能问题影响  

**验收标准** (EARS格式):
- **WHEN** 我加载或保存1.7MB的粒子系统配置文件 **THEN** 操作应该在5秒内完成
- **IF** 系统处理大型XML文件 **THEN** 内存使用峰值应该低于100MB
- **FOR** 所有大小的粒子系统配置文件 **VERIFY** 处理时间和内存使用在可接受范围内

**技术说明**:
- 需要评估当前的性能瓶颈
- 考虑使用异步处理大型XML文件
- 优化内存使用和垃圾回收

**故事点**: 8
**优先级**: 中

---

#### Story: PRT-006 - 测试覆盖增强
**作为** 一个系统维护者  
**我想要** 全面的测试覆盖来确保修复的稳定性  
**以便** 未来的修改不会破坏现有功能  

**验收标准** (EARS格式):
- **WHEN** 我运行所有ParticleSystems相关的测试 **THEN** 所有测试都应该通过
- **IF** 我修改ParticleSystemsDO或相关代码 **THEN** 相关测试应该能够及时发现问题
- **FOR** 所有修复的功能点 **VERIFY** 都有对应的测试用例覆盖

**技术说明**:
- 需要添加单元测试覆盖所有修复的场景
- 添加集成测试验证完整的序列化流程
- 考虑添加性能测试确保不影响处理速度

**故事点**: 5
**优先级**: 中

---

#### Story: PRT-007 - 向后兼容性保证
**作为** 一个Mod开发者  
**我想要** 修复后的编辑器能够处理所有现有的粒子系统配置  
**以便** 我的工作不会因为更新而中断  

**验收标准** (EARS格式):
- **WHEN** 我使用更新后的编辑器打开现有的粒子系统配置 **THEN** 配置应该能够正常加载和编辑
- **IF** 我保存配置文件 **THEN** 文件应该与游戏完全兼容
- **FOR** 所有现有的粒子系统配置文件 **VERIFY** 都能够正常处理

**技术说明**:
- 需要确保所有现有的XML结构都能正确处理
- 验证与游戏的兼容性
- 保持API接口的稳定性

**故事点**: 3
**优先级**: 高

## 用户旅程

### 旅程: Mod开发者修复粒子系统配置

1. **发现问题**: 用户发现粒子系统配置在保存后丢失了某些元素
2. **寻求帮助**: 用户查看文档或社区了解解决方案
3. **应用修复**: 用户使用修复后的编辑器重新编辑配置
4. **验证结果**: 用户确认配置保存后完整性得到保持
5. **继续工作**: 用户能够继续开发Mod而不受技术问题影响

### 旅程: 测试人员验证修复

1. **准备测试**: 测试人员准备包含各种边界情况的测试用例
2. **执行测试**: 运行所有ParticleSystems相关的测试
3. **分析结果**: 检查测试报告和覆盖率
4. **报告问题**: 发现并报告任何遗留问题
5. **验证修复**: 确认所有问题都已解决

## 验收标准矩阵

| 用户故事 | 功能验收 | 性能验收 | 兼容性验收 | 测试验收 |
|----------|----------|----------|------------|----------|
| PRT-001 | ✅ | ⚪ | ✅ | ✅ |
| PRT-002 | ✅ | ⚪ | ✅ | ✅ |
| PRT-003 | ✅ | ⚪ | ✅ | ✅ |
| PRT-004 | ✅ | ⚪ | ✅ | ✅ |
| PRT-005 | ✅ | ✅ | ✅ | ✅ |
| PRT-006 | ✅ | ⚪ | ✅ | ✅ |
| PRT-007 | ✅ | ⚪ | ✅ | ✅ |

## 依赖关系

### 关键依赖
- **PRT-001** 是 **PRT-002** 的前置条件
- **PRT-003** 依赖于 **PRT-001** 和 **PRT-002** 的完成
- **PRT-004** 需要在所有其他故事之前开始
- **PRT-006** 需要在所有功能修复完成后进行

### 外部依赖
- 需要访问真实的粒子系统配置文件进行测试
- 需要骑马与砍杀2游戏环境进行兼容性验证
- 需要性能测试工具和基准

## 风险和缓解措施

### 技术风险
- **复杂嵌套结构处理困难**: 分步骤实现，充分测试每个层次
- **性能问题**: 早期性能测试，及时优化瓶颈
- **向后兼容性破坏**: 保持API稳定，充分测试现有功能

### 项目风险
- **时间压力**: 优先处理关键功能，次要功能可以延后
- **测试覆盖不足**: 增加自动化测试，提高测试效率
- **用户需求变化**: 保持灵活的架构设计，便于后续调整

## 成功指标

### 技术指标
- 所有ParticleSystems测试通过率: 100%
- XML序列化准确性: 100%
- 性能指标满足要求
- 代码覆盖率 > 90%

### 用户指标
- 用户能够成功编辑和保存粒子系统配置
- 配置文件在游戏中正常工作
- 编辑器性能满足用户期望
- 用户满意度调查结果 > 4.5/5